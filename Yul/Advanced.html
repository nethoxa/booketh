<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Advanced - booketh</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../EVM/index.html"><strong aria-hidden="true">1.</strong> EVM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../EVM/Solidity Versions.html"><strong aria-hidden="true">1.1.</strong> Solidity versions</a></li><li class="chapter-item expanded "><a href="../EVM/Upgradeable.html"><strong aria-hidden="true">1.2.</strong> Upgradeable</a></li></ol></li><li class="chapter-item expanded "><a href="../Data locations/index.html"><strong aria-hidden="true">2.</strong> Data locations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Data locations/Stack.html"><strong aria-hidden="true">2.1.</strong> Stack</a></li><li class="chapter-item expanded "><a href="../Data locations/Memory.html"><strong aria-hidden="true">2.2.</strong> Memory</a></li><li class="chapter-item expanded "><a href="../Data locations/Storage.html"><strong aria-hidden="true">2.3.</strong> Storage</a></li><li class="chapter-item expanded "><a href="../Data locations/Calldata.html"><strong aria-hidden="true">2.4.</strong> Calldata</a></li></ol></li><li class="chapter-item expanded "><a href="../Tokens/index.html"><strong aria-hidden="true">3.</strong> Tokens</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Tokens/ERC 20.html"><strong aria-hidden="true">3.1.</strong> ERC 20</a></li><li class="chapter-item expanded "><a href="../Tokens/ERC 721.html"><strong aria-hidden="true">3.2.</strong> ERC 721</a></li><li class="chapter-item expanded "><a href="../Tokens/ERC 777.html"><strong aria-hidden="true">3.3.</strong> ERC 777</a></li><li class="chapter-item expanded "><a href="../Tokens/ERC 1155.html"><strong aria-hidden="true">3.4.</strong> ERC 1155</a></li><li class="chapter-item expanded "><a href="../Tokens/ERC 4626.html"><strong aria-hidden="true">3.5.</strong> ERC 4626</a></li></ol></li><li class="chapter-item expanded "><a href="../DeFi/index.html"><strong aria-hidden="true">4.</strong> DeFi</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../DeFi/Uniswap.html"><strong aria-hidden="true">4.1.</strong> Uniswap</a></li><li class="chapter-item expanded "><a href="../DeFi/AAVE.html"><strong aria-hidden="true">4.2.</strong> AAVE</a></li><li class="chapter-item expanded "><a href="../DeFi/Curve.html"><strong aria-hidden="true">4.3.</strong> Curve</a></li></ol></li><li class="chapter-item expanded "><a href="../Yul/index.html"><strong aria-hidden="true">5.</strong> Yul</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Yul/Basics.html"><strong aria-hidden="true">5.1.</strong> Basics</a></li><li class="chapter-item expanded "><a href="../Yul/Advanced.html" class="active"><strong aria-hidden="true">5.2.</strong> Advanced</a></li><li class="chapter-item expanded "><a href="../Yul/ERC 20.html"><strong aria-hidden="true">5.3.</strong> ERC 20</a></li><li class="chapter-item expanded "><a href="../Yul/Functions.html"><strong aria-hidden="true">5.4.</strong> Functions</a></li><li class="chapter-item expanded "><a href="../Yul/Opcodes.html"><strong aria-hidden="true">5.5.</strong> Opcodes</a></li></ol></li><li class="chapter-item expanded "><a href="../References.html"><strong aria-hidden="true">6.</strong> References</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">booketh</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="advanced"><a class="header" href="#advanced">Advanced</a></h1>
<p>CHECK <a href="https://smitrajput.notion.site/smitrajput/The-Dark-Arts-of-Yul-Explained-e0b2c178bc52437da1d101f4f96abbe4">THIS</a></p>
<h2 id="index"><a class="header" href="#index">Index</a></h2>
<ul>
<li><a href="#warning">Warning</a></li>
<li><a href="#unicode">Unicode</a></li>
<li><a href="#dynamic-arrays-and-mappings">Dynamic arrays and mappings</a></li>
<li><a href="#packed-values">Packed values</a></li>
<li><a href="#tips">Tips</a></li>
</ul>
<h2 id="warning"><a class="header" href="#warning">WARNING</a></h2>
<ol>
<li>Clean the upper-bits of variables with size less than 32 bytes, that are unknown, before using them in Yul</li>
<li>While writing library code, only return cleaned variables (no dirty bits either in lower or upper bits)</li>
<li>Booleans freshly passed into Yul might not necessarily be 0 or 1, so convert them to 0/1, before using</li>
<li>Common test cases for Yul code:
<ol>
<li>Pass dirty bits in the upper bits of variables of size &lt; 32 bytes</li>
<li>Pass dirty bits in the scratch space and onwards from free memory pointer, to check if they were not assumed to be 0</li>
<li>Check values in memory slots from free memory pointer, to see if memory was allocated properly</li>
</ol>
</li>
</ol>
<h2 id="unicode"><a class="header" href="#unicode">Unicode</a></h2>
<p>It's not exactly Yul but there is a Unicode character that can be used to force a right-to-left direction withing a text:</p>
<p><code>my-text.'U+202E'cod.exe -&gt; my-text.exe.doc instead of my-text.doc.exe</code></p>
<p>To type it in Linux do:</p>
<ol>
<li>Hold <code>ctrl</code> + <code>shift</code></li>
<li>Type <code>U202E</code></li>
<li>Release <code>ctrl</code> + <code>shift</code></li>
</ol>
<p>Use that whenever you can to break things that accept <code>string</code> or <code>bytes</code>. To put them in Yul, just do <code>\u202E</code>. From the docs:</p>
<p><code>An ASCII string is first viewed as a byte sequence, by viewing a non-escape ASCII character as a single byte whose value is the ASCII code, an escape \xNN as single byte with that value, and an escape \uNNNN as the UTF-8 sequence of bytes for that code point. The byte sequence must not exceed 32 bytes. The byte sequence is padded with zeros on the right to reach 32 bytes in length; in other words, the string is stored left-aligned. The padded byte sequence represents a 256-bit word whose most significant 8 bits are the ones from the first byte, i.e. the bytes are interpreted in big endian form</code></p>
<p>So that we could put in an argument that needs a type less than 32 bytes something like <code>VALUE\u202E</code> which will be padded until 32 bytes and once it gets processed, it will be converted to <code>000...VALUE</code> (kinda, I have to test it)</p>
<h2 id="dynamic-arrays-and-mappings"><a class="header" href="#dynamic-arrays-and-mappings">Dynamic arrays and mappings</a></h2>
<p>About dynamic arrays, the elements are located not in the slot of the <code>v</code> but rather on <code>keccak256(slot) + (index + element_size)</code> with a cast to <code>uint256</code>. For mappings, they are located on <code>keccak(key, slot)</code> with a cast to <code>uint256</code>. For nested types, we do a from-the-ouside approach, calculating the hashes of the outermost structure first. For example:</p>
<pre><code class="language-solidity">// dynamic arrays
uint256 slot;

assembly {
    slot := VAR.slot
}

bytes32 start = keccak256(abi.encode(slot))
uint256 sol;

// v[start + target]
assembly {
    sol := sload(add(start, target))
}
</code></pre>
<pre><code class="language-solidity">// nested mappings =&gt; mapping(uint256 =&gt; mapping(uint256 =&gt; uint256))
uint256 slot;

assembly {
    slot := VAR.slot
}

// hashs the key and uint256 value of slot
bytes32 locationOfParentValue = keccak256(abi.encode(key1, slot));
// hashs the parent key with the nested key
bytes32 locationOfNestedValue = keccak256(abi.encode(key2, locationOfParentValue));

uint256 sol;
// loads storage slot of location and returns ans
assembly {
    sol := sload(locationOfNestedValue)
}
</code></pre>
<h2 id="packed-values"><a class="header" href="#packed-values">Packed values</a></h2>
<p>To read/write packed values we must do the following:</p>
<ol>
<li>Load the storage slot -&gt; <code>slot := VAR.slot</code></li>
<li>Create a mask to isolate the value -&gt; <code>0x000...FFFFF</code> or whatever, just to clear the value we do not need</li>
<li><code>let VAR2 := and(slot, mask)</code> -&gt; read here, continue if write</li>
<li><code>let SHIFTEDVAR := shl/shr(mul(VAR.offset, 8), NEW)</code> -&gt; the mult is because <code>VAR.offset</code> is in bytes, and we have to convert that to bits. It's read like <code>shift to the left/right VAR.offset * 8 bytes the variable/slot NEW</code></li>
<li><code>let NEWSLOT := or/and(SHIFTEDVAL, VAR2)</code></li>
</ol>
<p>Just know that variables will always be packed from down to up. So this:</p>
<pre><code class="language-solidity">uint128 public C = 4;
uint104 public D = 6;
uint16 public E = 8;
uint8 public F = 1;
</code></pre>
<p>will be packed like this:</p>
<p><code>0x0100080000000000000000000000000600000000000000000000000000000004</code></p>
<p>Another example of reading from storage:</p>
<pre><code class="language-solidity">assembly{
    let slot := sload(VAR.slot)
    VAR := shr(mul(VAR.offset, 8), slot)
    let sol := and(0xffff,VAR)
}
</code></pre>
<p>For writing:</p>
<pre><code class="language-solidity">assembly{
    // lets overwrite una var in VAR
    value:= sload(VAR.slot)
    // if we know where is located, we just reset it with an and like this =&gt; the 0's are the places where is packed var 
    cleared := and(0xff0000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffff, value)
    // we &quot;move&quot; the variable to write to its position
    shifted := shl(mul(var.offset,8), NEW)
      
    // write
    NEWV := or(shifted,cleared)
    sstore(VAR.slot, NEWV)
}
</code></pre>
<p>It's just a three step process:</p>
<ol>
<li>Mask</li>
<li>Move (shl/shr)</li>
<li>Read/Write (and/or)</li>
</ol>
<h2 id="tips"><a class="header" href="#tips">Tips</a></h2>
<ul>
<li>Change <code>lt(i, n)</code> with <code>iszero(eq(i, n))</code> because it saves 4 gas/iteration</li>
<li>Change <code>mul(2^n, value)</code> with <code>shl(2^n, value)</code>. The same with <code>div</code> and <code>shr</code></li>
<li>Replace <code>for</code> with <code>for {} 1 {} {...}</code> with a <code>break</code> around there</li>
<li>Changing <code>switch</code>-case → infinite <code>for</code> loop with <code>if-break</code> statements, saves 1 gas + more when <code>eq()</code> → <code>iszero(gt())</code></li>
<li>Solidity auto-cleans upper-bits of down-casted variables while executing comparison operators. In Yul, we need to do it manually.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Yul/Basics.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../Yul/ERC 20.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Yul/Basics.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../Yul/ERC 20.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
